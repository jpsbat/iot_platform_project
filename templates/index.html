<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Monitoramento IoT</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>Monitoramento IoT</h1>

    <h2>Inserir Nova Leitura</h2>
    <form method="POST" action="/leituras">
      <label for="sensor_id">Sensor ID:</label>
      <input type="text" name="sensor_id" required><br>
      <label for="timestamp">Timestamp (YYYY-MM-DDTHH:MM:SS):</label>
      <input type="text" name="timestamp" required><br>
      <label for="tipo">Tipo:</label>
      <input type="text" name="tipo" required><br>
      <label for="temperatura">Temperatura:</label>
      <input type="number" step="any" name="temperatura" required><br>
      <label for="umidade">Umidade:</label>
      <input type="number" step="any" name="umidade" required><br>
      <label for="pressao">Pressão:</label>
      <input type="number" step="any" name="pressao" required><br>
      <button type="submit">Inserir</button>
    </form>

    <h2>Atualizar Leitura</h2>
    <form method="POST" action="/leituras/update">
      <label for="sensor_id">Sensor ID:</label>
      <input type="text" name="sensor_id" required><br>
      <label for="timestamp">Timestamp (YYYY-MM-DDTHH:MM:SS):</label>
      <input type="text" name="timestamp" required><br>
      <label for="tipo">Tipo:</label>
      <input type="text" name="tipo" required><br>
      <label for="temperatura">Temperatura:</label>
      <input type="number" step="any" name="temperatura" required><br>
      <label for="umidade">Umidade:</label>
      <input type="number" step="any" name="umidade" required><br>
      <label for="pressao">Pressão:</label>
      <input type="number" step="any" name="pressao" required><br>
      <button type="submit">Atualizar</button>
    </form>

    <h2>Deletar Leitura</h2>
    <form method="POST" action="/leituras/delete">
      <label for="sensor_id">Sensor ID:</label>
      <input type="text" name="sensor_id" required><br>
      <label for="timestamp">Timestamp (YYYY-MM-DDTHH:MM:SS):</label>
      <input type="text" name="timestamp" required><br>
      <button type="submit">Deletar</button>
    </form>

    <h2>Obter Última Leitura de um Sensor</h2>
    <form id="form-ultima">
      <label for="sensor_id_ultima">Sensor ID:</label>
      <input type="text" id="sensor_id_ultima" name="sensor_id" required>
      <button type="submit">Buscar</button>
    </form>

    <h2>Buscar Leituras por Intervalo</h2>
    <form id="form-intervalo">
      <label for="sensor_id_intervalo">Sensor ID:</label>
      <input type="text" id="sensor_id_intervalo" name="sensor_id" required>
      <label for="inicio">Início (YYYY-MM-DDTHH:MM:SS):</label>
      <input type="text" id="inicio" name="inicio" required>
      <label for="fim">Fim (YYYY-MM-DDTHH:MM:SS):</label>
      <input type="text" id="fim" name="fim" required>
      <button type="submit">Buscar</button>
    </form>

    <h2>Leituras Acima de um Limite</h2>
    <form id="form-limite">
      <label for="sensor_id_limite">Sensor ID:</label>
      <input type="text" id="sensor_id_limite" name="sensor_id" required>
      <label for="limite">Temperatura &gt; </label>
      <input type="number" step="any" id="limite" name="limite" required>
      <button type="submit">Buscar</button>
    </form>

    <h2>Listar Todos os Sensores</h2>
    <form id="form-sensores">
      <button type="submit">Listar Sensores</button>
    </form>

    <h2>Leituras Anômalas nas Últimas 24h</h2>
    <form id="form-alertas">
      <label for="sensor_id_alerta">Sensor ID:</label>
      <input type="text" id="sensor_id_alerta" name="sensor_id" required>
      <label for="limite_alerta">Temperatura &gt; </label>
      <input type="number" step="any" id="limite_alerta" name="limite" value="80.0" required>
      <button type="submit">Buscar</button>
    </form>

    <div class="resultado" id="resultado"></div>
  </div>

  <script>
    function renderTable(data) {
      if (!Array.isArray(data) || data.length === 0) return "<em>Nenhum resultado encontrado.</em>";
      let cols = Object.keys(data[0]);
      let html = "<table><thead><tr>";
      cols.forEach(c => html += `<th>${c}</th>`);
      html += "</tr></thead><tbody>";
      data.forEach(row => {
        html += "<tr>";
        cols.forEach(c => html += `<td>${row[c]}</td>`);
        html += "</tr>";
      });
      html += "</tbody></table>";
      return html;
    }

    function renderList(data) {
      if (!Array.isArray(data) || data.length === 0) return "<em>Nenhum resultado encontrado.</em>";
      return "<ul>" + data.map(item => `<li>${item}</li>`).join("") + "</ul>";
    }

    document.getElementById("form-ultima").onsubmit = async function(e) {
      e.preventDefault();
      let sensor_id = document.getElementById("sensor_id_ultima").value;
      let res = await fetch(`/leituras/ultima/${sensor_id}`);
      let data = await res.json();
      document.getElementById("resultado").innerHTML = "<b>Última leitura:</b><br>" + renderTable(data);
    };

    document.getElementById("form-intervalo").onsubmit = async function(e) {
      e.preventDefault();
      let sensor_id = document.getElementById("sensor_id_intervalo").value;
      let inicio = document.getElementById("inicio").value;
      let fim = document.getElementById("fim").value;
      let res = await fetch(`/leituras/intervalo?sensor_id=${sensor_id}&inicio=${inicio}&fim=${fim}`);
      let data = await res.json();
      document.getElementById("resultado").innerHTML = "<b>Leituras no intervalo:</b><br>" + renderTable(data);
    };

    document.getElementById("form-limite").onsubmit = async function(e) {
      e.preventDefault();
      let sensor_id = document.getElementById("sensor_id_limite").value;
      let limite = document.getElementById("limite").value;
      let res = await fetch(`/leituras/limite?sensor_id=${sensor_id}&limite=${limite}`);
      let data = await res.json();
      document.getElementById("resultado").innerHTML = "<b>Leituras acima do limite:</b><br>" + renderTable(data);
    };

    document.getElementById("form-sensores").onsubmit = async function(e) {
      e.preventDefault();
      let res = await fetch(`/sensores`);
      let data = await res.json();
      document.getElementById("resultado").innerHTML = "<b>Sensores cadastrados:</b><br>" + renderList(data);
    };

    document.getElementById("form-alertas").onsubmit = async function(e) {
      e.preventDefault();
      let sensor_id = document.getElementById("sensor_id_alerta").value;
      let limite = document.getElementById("limite_alerta").value;
      let res = await fetch(`/leituras/alertas?sensor_id=${sensor_id}&limite=${limite}`);
      let data = await res.json();
      document.getElementById("resultado").innerHTML = "<b>Leituras anômalas nas últimas 24h:</b><br>" + renderTable(data);
    };
  </script>
</body>
</html>